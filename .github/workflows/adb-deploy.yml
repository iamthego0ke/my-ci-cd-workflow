name: Oracle Autonomous DB CI/CD Pipeline

on:
  push:
    branches: [ test-sql-cmds-with-cicd-pipeline ]
  pull_request:
    branches: [ test-sql-cmds-with-cicd-pipeline ]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout your repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install sqlfluff for SQL linting
      - name: Install sqlfluff (SQL linter)
        run: pip install sqlfluff

      # Step 3: Lint all .sql files in the repo
      - name: Lint SQL files
        run: sqlfluff lint *.sql --dialect oracle || echo "Lint complete (warnings OK for learning)"

      # Step 4: Install Oracle Instant Client & SQLcl (command-line tool)
      - name: Install Oracle Instant Client & SQLcl
        run: |
          wget https://download.oracle.com/otn_software/linux/instantclient/2370000/instantclient-basiclite-linux.x64-23.7.0.24.07.zip
          unzip instantclient-basiclite-linux.x64-23.7.0.24.07.zip
          wget https://download.oracle.com/otn_software/java/sqlcl/sqlcl-23.4.0.24.07.zip
          unzip sqlcl-23.4.0.24.07.zip
          export PATH=$PWD/instantclient_23_7:$PWD/sqlcl/bin:$PATH

      # Step 5: Decode and extract the wallet from GitHub secret
      - name: Decode and unzip ADB wallet
        run: |
          echo "${{ secrets.ADB_WALLET_BASE64 }}" | base64 -d > wallet.zip
          unzip wallet.zip -d wallet

      # Step 6: Deploy schema (run your SQL script against ADB)
      - name: Deploy schema to Autonomous Database
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @schema.sql ?TNS_ADMIN=wallet

      # Step 7: Run a simple smoke test (verify table exists)
      - name: Smoke test - Check table count
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @test.sql ?TNS_ADMIN=wallet > test_output.txt
          cat test_output.txt

      # Step 8: Cleanup (always run, even if failed)
      - name: Cleanup temporary files
        if: always()
        run: rm -rf wallet* *.zip
