name: Oracle Autonomous DB CI/CD Pipeline (19c Client - Mirror Fix)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install sqlfluff (SQL linter)
        run: pip install sqlfluff

      - name: Lint SQL files
        run: sqlfluff lint *.sql --dialect oracle || echo "Lint complete (warnings OK)"

      - name: Install Oracle Instant Client 19c & SQLcl (Mirror Fix)
        run: |
          curl -L -o instantclient.zip \
            https://download.oracle.com/otn_software/linux/instantclient/1922000/instantclient-basiclite-linux.x64-19.22.0.0.0dbru.zip
          unzip instantclient.zip

          # CORRECTED: Swapped broken link for official Oracle SQLcl latest link
          curl -L -o sqlcl.zip \
            https://download.oracle.com/otn_software/java/sqldev/sqlcl-latest.zip
          unzip sqlcl.zip

          # CORRECTED: Using GITHUB_ENV so the path persists to the 'Deploy' and 'Smoke test' steps
          echo "LD_LIBRARY_PATH=$PWD/instantclient_19_22" >> $GITHUB_ENV
          echo "PATH=$PWD/instantclient_19_22:$PWD/sqlcl/bin:$PATH" >> $GITHUB_ENV

          ls -lh sqlcl.zip
          ./sqlcl/bin/sql -v

      - name: Decode and unzip ADB wallet
        run: |
          echo "${{ secrets.ADB_WALLET_BASE64 }}" | base64 -d > wallet.zip
          unzip wallet.zip -d wallet

      - name: Deploy schema to Autonomous Database
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @schema.sql ?TNS_ADMIN=wallet

      - name: Smoke test - Check table count
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @test.sql ?TNS_ADMIN=wallet > test_output.txt
          cat test_output.txt

      - name: Cleanup
        if: always()
        run: rm -rf wallet* *.zip instantclient* sqlcl*
