name: Oracle Autonomous DB CI/CD Pipeline (Fixed)

on:
  push:
    branches: 
  pull_request:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install SQLfluff (SQL linter)
        run: pip install sqlfluff

      - name: Lint SQL files
        run: sqlfluff lint *.sql --dialect oracle || echo "Lint complete (warnings OK)"

      - name: Install Oracle Instant Client & SQLcl
        run: |
          # Download and unzip Instant Client 19.22
          curl -L -o instantclient.zip https://download.oracle.com/otn_software/linux/instantclient/1922000/instantclient-basiclite-linux.x64-19.22.0.0.0dbru.zip
          unzip instantclient.zip
          
          # Download and unzip Latest SQLcl (Official Oracle Link)
          curl -L -o sqlcl.zip https://download.oracle.com/otn_software/java/sqldev/sqlcl-latest.zip
          unzip sqlcl.zip

          # Persist paths for subsequent steps
          echo "LD_LIBRARY_PATH=$PWD/instantclient_19_22" >> $GITHUB_ENV
          echo "PATH=$PWD/instantclient_19_22:$PWD/sqlcl/bin:$PATH" >> $GITHUB_ENV

      - name: Verify SQLcl Installation
        run: sql -v

      - name: Decode and unzip ADB wallet
        run: |
          echo "${{ secrets.ADB_WALLET_BASE64 }}" | base64 -d > wallet.zip
          unzip wallet.zip -d wallet

      - name: Deploy schema to Autonomous Database
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          # Using TNS_ADMIN environment variable pointing to the absolute path of the wallet
          export TNS_ADMIN=$PWD/wallet
          echo "exit" | sql -S admin/"${ADMIN_PASSWORD}"@"${CONNECTION_STRING}" @schema.sql

      - name: Smoke test - Check table count
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          export TNS_ADMIN=$PWD/wallet
          sql -S admin/"${ADMIN_PASSWORD}"@"${CONNECTION_STRING}" @test.sql > test_output.txt
          cat test_output.txt

      - name: Cleanup
        if: always()
        run: rm -rf wallet* *.zip instantclient* sqlcl*
