name: Oracle Autonomous DB CI/CD Pipeline (19c Client)

on:
  push: 
  pull_request: 
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install sqlfluff (SQL linter)
        run: pip install sqlfluff

      - name: Lint SQL files
        run: sqlfluff lint *.sql --dialect oracle || echo "Lint complete (warnings OK)"

      - name: Install Oracle Instant Client 19c & SQLcl
        run: |
          # Download Instant Client Basic Light 19.24 (long-term support, stable for ADB)
          curl -o instantclient.zip https://download.oracle.com/otn_software/linux/instantclient/1924000/instantclient-basiclite-linux.x64-19.24.0.0.0dbru.zip
          unzip instantclient.zip
          # Download SQLcl 19.4 (compatible with 19c client)
          curl -o sqlcl.zip https://download.oracle.com/otn_software/java/sqlcl/sqlcl-19.4.0.zip
          unzip sqlcl.zip
          # Set PATH correctly for 19c
          export LD_LIBRARY_PATH=$PWD/instantclient_19_24:$LD_LIBRARY_PATH
          export PATH=$PWD/instantclient_19_24:$PWD/sqlcl/bin:$PATH

      - name: Decode and unzip ADB wallet
        run: |
          echo "${{ secrets.ADB_WALLET_BASE64 }}" | base64 -d > wallet.zip
          unzip wallet.zip -d wallet

      - name: Deploy schema to Autonomous Database
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @schema.sql ?TNS_ADMIN=wallet

      - name: Smoke test - Check table count
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          echo "${{ secrets.ADB_ADMIN_PASSWORD }}" | sql -S admin/"${{ secrets.ADB_ADMIN_PASSWORD }}"@"${{ secrets.ADB_CONNECTION_STRING }}" @test.sql ?TNS_ADMIN=wallet > test_output.txt
          cat test_output.txt

      - name: Cleanup
        if: always()
        run: rm -rf wallet* *.zip instantclient* sqlcl*
