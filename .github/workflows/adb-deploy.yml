name: Oracle Autonomous DB CI/CD Pipeline (19c Client - Fixed)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------------
      # SQL Lint
      # -------------------------------
      - name: Install sqlfluff
        run: pip install sqlfluff

      - name: Lint SQL files
        run: sqlfluff lint *.sql --dialect oracle || echo "Lint warnings allowed"

      # -------------------------------
      # Install Oracle Client + SQLcl
      # -------------------------------
      - name: Install Oracle Instant Client & SQLcl
        run: |
          set -e

          # Instant Client 19c
          curl -L -o instantclient.zip \
            https://download.oracle.com/otn_software/linux/instantclient/1922000/instantclient-basiclite-linux.x64-19.22.0.0.0dbru.zip
          unzip instantclient.zip

          # SQLcl (official latest)
          curl -L -o sqlcl.zip \
            https://download.oracle.com/otn_software/java/sqldeveloper/sqlcl-latest.zip
          unzip sqlcl.zip

          export LD_LIBRARY_PATH=$PWD/instantclient_19_22:$LD_LIBRARY_PATH
          export PATH=$PWD/instantclient_19_22:$PWD/sqlcl/bin:$PATH

          sql -v

      # -------------------------------
      # Decode Wallet
      # -------------------------------
      - name: Decode ADB wallet
        run: |
          set -e
          echo "${{ secrets.ADB_WALLET_BASE64 }}" | tr -d '\r\n ' base64 -d > wallet.zip
          unzip -o wallet.zip -d wallet

      # -------------------------------
      # Deploy Schema
      # -------------------------------
      - name: Deploy schema
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          set -e

          export LD_LIBRARY_PATH=$PWD/instantclient_19_22:$LD_LIBRARY_PATH
          export PATH=$PWD/instantclient_19_22:$PWD/sqlcl/bin:$PATH
          export TNS_ADMIN=$PWD/wallet

          sql -S admin/"$ADMIN_PASSWORD"@"$CONNECTION_STRING" @schema.sql

      # -------------------------------
      # Smoke Test
      # -------------------------------
      - name: Smoke test
        env:
          CONNECTION_STRING: ${{ secrets.ADB_CONNECTION_STRING }}
          ADMIN_PASSWORD: ${{ secrets.ADB_ADMIN_PASSWORD }}
        run: |
          set -e

          export LD_LIBRARY_PATH=$PWD/instantclient_19_22:$LD_LIBRARY_PATH
          export PATH=$PWD/instantclient_19_22:$PWD/sqlcl/bin:$PATH
          export TNS_ADMIN=$PWD/wallet

          sql -S admin/"$ADMIN_PASSWORD"@"$CONNECTION_STRING" @test.sql > test_output.txt
          cat test_output.txt

      # -------------------------------
      # Cleanup
      # -------------------------------
      - name: Cleanup
        if: always()
        run: rm -rf wallet* *.zip instantclient* sqlcl*
